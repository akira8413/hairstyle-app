<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©¦ç€å±¥æ­´ - ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«è©¦ç€ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“‹ è©¦ç€å±¥æ­´</h1>
            <div class="header-buttons">
                <button class="btn btn-back" onclick="window.location.href='index.html'">ğŸ  ãƒ›ãƒ¼ãƒ </button>
                <button class="btn btn-primary" onclick="window.location.href='hairstyle.html'">+ æ–°ã—ãè©¦ã™</button>
            </div>
        </header>

        <main>
            <!-- çµ±è¨ˆæƒ…å ± -->
            <div class="hairstyle-stats-section">
                <h2>ğŸ“Š çµ±è¨ˆ</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ’‡</div>
                        <div class="stat-content">
                            <h3 id="totalTries">0</h3>
                            <p>è©¦ç€å›æ•°</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">â­</div>
                        <div class="stat-content">
                            <h3 id="avgScore">0</h3>
                            <p>å¹³å‡ä¼¼åˆã†åº¦</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ†</div>
                        <div class="stat-content">
                            <h3 id="bestScore">0</h3>
                            <p>æœ€é«˜ã‚¹ã‚³ã‚¢</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ¨</div>
                        <div class="stat-content">
                            <h3 id="mostCommonStyle">-</h3>
                            <p>ã‚ˆãè©¦ã™ã‚¹ã‚¿ã‚¤ãƒ«</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è©¦ç€å±¥æ­´ä¸€è¦§ -->
            <div class="hairstyle-list-section">
                <div class="section-header">
                    <h2>ğŸ’‡ è©¦ç€å±¥æ­´</h2>
                    <div class="sort-controls">
                        <select id="sortOrder" class="form-control filter-select">
                            <option value="desc">æ–°ã—ã„é †</option>
                            <option value="asc">å¤ã„é †</option>
                            <option value="score_desc">ã‚¹ã‚³ã‚¢é«˜ã„é †</option>
                            <option value="score_asc">ã‚¹ã‚³ã‚¢ä½ã„é †</option>
                        </select>
                    </div>
                </div>

                <div id="historyContainer" class="hairstyle-history-container">
                    <!-- è©¦ç€å±¥æ­´ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>

                <!-- ç©ºçŠ¶æ…‹ -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <h3>ã¾ã è©¦ç€å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                    <p>ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
                    <button class="btn btn-primary" onclick="window.location.href='hairstyle.html'">
                        <span class="icon">ğŸ’‡</span>
                        ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è©¦ã™
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const totalTries = document.getElementById('totalTries');
        const avgScore = document.getElementById('avgScore');
        const bestScore = document.getElementById('bestScore');
        const mostCommonStyle = document.getElementById('mostCommonStyle');
        const historyContainer = document.getElementById('historyContainer');
        const emptyState = document.getElementById('emptyState');
        const sortOrder = document.getElementById('sortOrder');

        // å…¨è©¦ç€å±¥æ­´ã‚’ä¿æŒ
        let allHistory = [];

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        window.addEventListener('load', () => {
            loadAllHistory();
            displayStatistics();
            displayHistory();
        });

        // ã‚½ãƒ¼ãƒˆé †å¤‰æ›´æ™‚
        sortOrder.addEventListener('change', () => {
            displayHistory();
        });

        // å…¨è©¦ç€å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
        function loadAllHistory() {
            allHistory = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (!data) continue;

                    // hairstyle_ã§å§‹ã¾ã‚‹ã‚­ãƒ¼
                    if (key && key.startsWith('hairstyle_')) {
                        allHistory.push(data);
                    }
                } catch (e) {
                    console.error('Failed to parse data:', key, e);
                }
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ–°ã—ã„é †
            allHistory.sort((a, b) => {
                const dateA = new Date(a.savedAt || 0);
                const dateB = new Date(b.savedAt || 0);
                return dateB - dateA;
            });
        }

        // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
        function displayStatistics() {
            // è©¦ç€å›æ•°
            totalTries.textContent = allHistory.length;

            if (allHistory.length === 0) {
                avgScore.textContent = '0';
                bestScore.textContent = '0';
                mostCommonStyle.textContent = '-';
                return;
            }

            // å¹³å‡ã‚¹ã‚³ã‚¢
            const totalScore = allHistory.reduce((sum, item) => {
                return sum + (item.compatibility?.score || 0);
            }, 0);
            const avg = Math.round(totalScore / allHistory.length);
            avgScore.textContent = avg;

            // æœ€é«˜ã‚¹ã‚³ã‚¢
            const maxScore = Math.max(...allHistory.map(item => item.compatibility?.score || 0));
            bestScore.textContent = maxScore;

            // ã‚ˆãè©¦ã™ã‚¹ã‚¿ã‚¤ãƒ«
            const styles = {};
            allHistory.forEach(item => {
                const style = item.styleAnalysis?.style || 'ãã®ä»–';
                styles[style] = (styles[style] || 0) + 1;
            });
            const mostCommon = Object.keys(styles).reduce((a, b) =>
                styles[a] > styles[b] ? a : b, '-');
            mostCommonStyle.textContent = mostCommon;
        }

        // è©¦ç€å±¥æ­´ã‚’è¡¨ç¤º
        function displayHistory() {
            historyContainer.innerHTML = '';

            if (allHistory.length === 0) {
                emptyState.style.display = 'block';
                historyContainer.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            historyContainer.style.display = 'grid';

            // ã‚½ãƒ¼ãƒˆ
            const sortedHistory = [...allHistory];
            const order = sortOrder.value;

            if (order === 'asc') {
                sortedHistory.sort((a, b) => new Date(a.savedAt) - new Date(b.savedAt));
            } else if (order === 'score_desc') {
                sortedHistory.sort((a, b) => (b.compatibility?.score || 0) - (a.compatibility?.score || 0));
            } else if (order === 'score_asc') {
                sortedHistory.sort((a, b) => (a.compatibility?.score || 0) - (b.compatibility?.score || 0));
            }

            // ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
            sortedHistory.forEach(item => {
                const card = createHistoryCard(item);
                historyContainer.appendChild(card);
            });
        }

        // è©¦ç€å±¥æ­´ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
        function createHistoryCard(item) {
            const card = document.createElement('div');
            card.className = 'hairstyle-history-card';

            // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const date = new Date(item.savedAt);
            const dateStr = date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });

            // ã‚¹ã‚³ã‚¢
            const score = item.compatibility?.score || 0;
            const scoreClass = getScoreClass(score);

            // ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«æƒ…å ±
            const style = item.styleAnalysis?.style || 'ä¸æ˜';
            const length = item.styleAnalysis?.length || '-';
            const color = item.styleAnalysis?.color || '-';

            card.innerHTML = `
                <div class="history-card-images">
                    <img src="${item.faceImage}" alt="é¡”å†™çœŸ" class="history-face-image">
                    <div class="history-arrow">â†’</div>
                    <img src="${item.styleImage}" alt="ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«" class="history-style-image">
                </div>
                <div class="history-card-content">
                    <div class="history-card-header">
                        <h3>${style}</h3>
                        <span class="score-badge ${scoreClass}">${score}/100</span>
                    </div>
                    <div class="history-card-details">
                        <span class="history-detail-item">ğŸ“ ${length}</span>
                        <span class="history-detail-item">ğŸ¨ ${color}</span>
                        <span class="history-detail-item">ğŸ“… ${dateStr}</span>
                    </div>
                    <div class="history-card-face-type">
                        <strong>é¡”å‹:</strong> ${item.faceAnalysis?.faceShape || 'ä¸æ˜'}
                    </div>
                </div>
                <div class="history-card-actions">
                    <button class="btn btn-small btn-danger" onclick="deleteHistory('${item.hairstyleId}')">
                        <span class="icon">ğŸ—‘ï¸</span>
                        å‰Šé™¤
                    </button>
                </div>
            `;

            return card;
        }

        // ã‚¹ã‚³ã‚¢ã®ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 75) return 'score-good';
            if (score >= 60) return 'score-fair';
            return 'score-poor';
        }

        // è©¦ç€å±¥æ­´ã‚’å‰Šé™¤
        function deleteHistory(hairstyleId) {
            if (!confirm('ã“ã®è©¦ç€å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            localStorage.removeItem(hairstyleId);

            // ãƒªãƒ­ãƒ¼ãƒ‰
            loadAllHistory();
            displayStatistics();
            displayHistory();

            alert('âœ“ å‰Šé™¤ã—ã¾ã—ãŸ');
        }
    </script>
</body>
</html>
